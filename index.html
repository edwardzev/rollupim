<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="generator" content="Hostinger Horizons" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Canonical URL -->
    <link rel="canonical" href="https://start.printmarket.club/" />

    <!-- Open Graph / Facebook / WhatsApp defaults -->
    <meta property="og:title" content="רולאפ להרכבה עצמית – הכי זול בישראל | פרינט מרקט" />
    <meta property="og:description" content="רולאפ להרכבה עצמית במחיר הכי זול בישראל. העלו את הגרפיקה שלכם, קבלו תצוגה מקדימה ומשלוח מהיר לכל הארץ." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://start.printmarket.club/" />
    <meta property="og:image" content="https://start.printmarket.club/og/rollup-hero.jpg" />
    <meta property="og:locale" content="he_IL" />

    <!-- Twitter Card defaults -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="רולאפ להרכבה עצמית – הכי זול בישראל | פרינט מרקט" />
    <meta name="twitter:description" content="רולאפ להרכבה עצמית במחיר הכי זול בישראל. העלו את הגרפיקה שלכם, קבלו תצוגה מקדימה ומשלוח מהיר לכל הארץ." />
    <meta name="twitter:image" content="https://start.printmarket.club/og/rollup-hero.jpg" />

    <!-- Organization JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Print Market Ltd.",
      "url": "https://start.printmarket.club/",
      "logo": "https://start.printmarket.club/og/logo.png",
      "sameAs": [
        "https://www.facebook.com/printmarket.il",
        "https://www.instagram.com/print.market",
        "https://www.youtube.com/@printmarket"
      ],
      "contactPoint": [{
        "@type": "ContactPoint",
        "telephone": "+972-3-0000000",
        "contactType": "customer service",
        "areaServed": "IL",
        "availableLanguage": ["he", "en", "ru"]
      }]
    }
    </script>

    <!-- Theme color (optional) -->
    <meta name="theme-color" content="#ffffff" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>רולאפ להרכבה עצמית</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>

    <!-- Rollupim Support Chat (MVP Step 1) -->
    <script>
(() => {
  if (document.getElementById('rollupim-chat-root')) return;

  // Decide API base:
  // - If window.ROLLUPIM_API_BASE is set (e.g., on Vercel), use it (same-domain serverless or external).
  // - If running on localhost, default to the local dev server (:3001).
  // - Otherwise, use relative '/api' so Vercel Functions work without CORS.
  const API_BASE = (typeof window.ROLLUPIM_API_BASE === 'string' && window.ROLLUPIM_API_BASE)
    ? window.ROLLUPIM_API_BASE.replace(/\/+$/,'')
    : ((location.hostname === 'localhost' || location.hostname === '127.0.0.1')
        ? 'http://localhost:3001'
        : '');

  const host = document.createElement('div');
  host.id = 'rollupim-chat-root';
  // Move to TOP-RIGHT
  Object.assign(host.style, { position:'fixed', left:'16px', top:'calc(16px + env(safe-area-inset-top))', zIndex: '2147483647' });
  host.style.pointerEvents = 'auto';
  document.body.appendChild(host);

// ---- reveal when the video section is reached ----
host.style.opacity = '0';
host.style.transform = 'translateY(-6px)';
host.style.transition = 'opacity 220ms ease, transform 220ms ease';

// Pick a target to observe (priority: [data-chat-reveal], first <video>, or #chatRevealVideo)
const target =
  document.querySelector('[data-chat-reveal]') ||
  document.querySelector('video') ||
  document.getElementById('chatRevealVideo');

function reveal() {
  host.style.opacity = '1';
  host.style.transform = 'translateY(0)';
}
reveal(); // TEMP: force visible immediately to debug click handler

if (target && 'IntersectionObserver' in window) {
  const io = new IntersectionObserver((entries) => {
    for (const e of entries) {
      if (e.isIntersecting) {
        reveal();
        io.disconnect(); // reveal once
        break;
      }
    }
  }, { root: null, threshold: 0.4 }); // ~40% of target visible
  io.observe(target);

  // Safety fallback if user never reaches the video (optional)
  setTimeout(() => { if (host.style.opacity === '0') reveal(); }, 12000);
} else {
  // Fallback: crude scroll trigger
  function onScrollFallback() {
    if (window.scrollY > 600) {
      reveal();
      window.removeEventListener('scroll', onScrollFallback);
    }
  }
  window.addEventListener('scroll', onScrollFallback, { passive: true });
  setTimeout(() => { if (host.style.opacity === '0') reveal(); }, 12000);
}

const shadow = host.attachShadow({ mode: 'open' });



  const css = `
    :host { all: initial; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    /* Chat button styling — compact pill, 2-line */
    .btn {
      width: 130px;            /* fixed width so the label wraps to 2 lines */
      height: 70px;
      padding: 6px 8px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
      color: #fff;
      background: #2563eb;    /* bulk-order blue */
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.45);
      font-weight: 800;
      font-size: 20px;
      line-height: 1.2;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      white-space: normal;
    }
    .btn:hover { background: #1d4ed8; }

    /* Panel: mobile-safe width/height and scroll behavior */
    .wrap {
      width: min(420px, 92vw);
      height: 72dvh; /* dynamic viewport for modern mobile */
      max-height: calc(var(--vh, 1vh) * 78); /* fallback for older Safari */
      display:flex; flex-direction:column;
      background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.15); overflow:hidden;
    }
    .bar { display:flex; align-items:center; justify-content:space-between; padding: calc(12px + env(safe-area-inset-top)) 14px 12px; background:#2563eb; color:#fff; font-weight:700; }
    .x { background:transparent; border:0; color:#fff; font-size:20px; cursor:pointer; line-height:1; }

    .body { flex:1; display:flex; flex-direction:column; gap:8px; padding:12px; background:#f8fafc; overflow:auto; -webkit-overflow-scrolling:touch; }
    .msg { max-width:85%; padding:10px; border-radius:12px; word-break:break-word; }
    .a { align-self:flex-start; background:#fff; }
    .u { align-self:flex-end; background:#e2e8f0; }

    .foot { display:flex; gap:6px; padding:8px; border-top:1px solid #e5e7eb; background:#fff; padding-bottom: max(12px, env(safe-area-inset-bottom)); }
    .in  { flex:1; border:1px solid #e5e7eb; border-radius:10px; padding:10px; font-size:16px; }
    .send{ background:#2563eb; color:#fff; border:0; border-radius:10px; padding:0 14px; cursor:pointer; font-size:16px; }

    .hidden { display:none; }

    /* Small phones */
    @media (max-width: 480px) {
      .wrap { width: 96vw; height: 65dvh; border-radius:14px; }
      .bar  { font-size:16px; }
      .msg  { font-size:15px; }
      .btn  { width:52px; height:52px; font-size:15px; border-radius:999px; line-height:1; white-space:nowrap; }
    }

    .btn{ pointer-events:auto; }
    #openBtn{ pointer-events:auto; }
  `;

  const html = `
    <style>${css}</style>
    <!-- Updated label -->
    <button class="btn" id="openBtn" aria-label="פתח תמיכה">אנחנו כאן <br>לכל  שאלה </button>

    <div class="wrap hidden" id="panel" role="dialog" aria-label="Rollupim Support">
      <div class="bar">
        <div>תמיכה</div>
        <button class="x" id="closeBtn" aria-label="סגור">×</button>
      </div>
      <div class="body" id="msgs">
        <div class="msg a">שלום! איך אפשר לעזור? כדי לבדוק סטטוס הזמנה, כתבו מספר הזמנה / מייל / טלפון.</div>
      </div>
      <div class="foot">
        <input class="in" id="input" placeholder="כתוב הודעה…" />
        <button class="send" id="sendBtn">שלח</button>
      </div>
    </div>
  `;

  shadow.innerHTML = html;

  const $ = (sel) => shadow.querySelector(sel);
  const openBtn = $('#openBtn');
  const panel = $('#panel');
  const closeBtn = $('#closeBtn');
  const sendBtn = $('#sendBtn');
  const chatInput = $('#input');
  const chatMsgs  = $('#msgs');

  // Defensive delegation in case direct binding fails on some devices
  shadow.addEventListener('click', (e) => {
    const btnEl = e.target.closest && e.target.closest('#openBtn');
    if (btnEl) {
      e.preventDefault(); e.stopPropagation();
      console.log('[chat] open (delegated)');
      toggle(true);
    }
  }, { passive: false });

  // Keep input visible when keyboard opens and auto-scroll to last message (attach after DOM refs exist)
  if (chatInput && chatMsgs) {
    chatInput.addEventListener('focus', () => {
      setTimeout(() => {
        try { chatMsgs.scrollTop = chatMsgs.scrollHeight; } catch {}
        try { host.scrollIntoView({ block: 'nearest' }); } catch {}
      }, 120);
    });
  }

  function toggle(open) {
    openBtn.classList.toggle('hidden', open);
    panel.classList.toggle('hidden', !open);
    if (open) setTimeout(() => chatInput && chatInput.focus(), 0);
  }

  function push(role, text) {
    const div = document.createElement('div');
    div.className = `msg ${role === 'user' ? 'u' : 'a'}`;
    div.textContent = text;
    chatMsgs.appendChild(div);
    chatMsgs.scrollTop = chatMsgs.scrollHeight;
  }

  openBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); console.log('[chat] open'); toggle(true); });
  openBtn.addEventListener('touchend', (e) => { e.preventDefault(); e.stopPropagation(); console.log('[chat] open (touch)'); toggle(true); }, { passive: false });
  closeBtn.addEventListener('click', () => { console.log('[chat] close'); toggle(false); });

  async function send() {
    const text = (chatInput.value || '').trim();
    if (!text) return;
    chatInput.value = '';
    push('user', text);

    try {
      const r = await fetch(`${API_BASE}/api/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });
      if (!r.ok) throw new Error('bad status ' + r.status);
      const data = await r.json();
      push('assistant', data.reply || 'אוקיי');
    } catch (e) {
      push('assistant', '❌ לא הצלחתי להתחבר לשרת. ודאו שהשרת פועל ושהפרוקסי מוגדר.');
      console.error(e);
    }
  }

  sendBtn.addEventListener('click', send);
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
  });
})();
</script>
  </body>
</html>